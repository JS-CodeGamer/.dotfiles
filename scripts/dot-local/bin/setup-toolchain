#!/usr/bin/env bash
#
# setup-toolchain.sh — Initialize toolchain sources and structure
#
# Usage:
#   ./setup-toolchain.sh [--system] [--binutils <tag>] [--gcc <tag>]
#
set -euo pipefail

# --- Colors ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info()  { echo -e "${BLUE}ℹ️  $*${NC}"; }
log_ok()    { echo -e "${GREEN}✅ $*${NC}"; }
log_warn()  { echo -e "${YELLOW}⚠️  $*${NC}"; }
log_error() { echo -e "${RED}❌ $*${NC}" >&2; }

# --- Default options ---
INSTALL_MODE="user"
BINUTILS_TAG=""
GCC_TAG=""
NEWLIB_TAG=""

# --- Parse flags ---
while [[ $# -gt 0 ]]; do
  case "$1" in
    --system)
      INSTALL_MODE="system"
      shift
      ;;
    --binutils)
      BINUTILS_TAG="$2"
      shift 2
      ;;
    --gcc)
      GCC_TAG="$2"
      shift 2
      ;;
    --newlib)
      NEWLIB_TAG="$2"
      shift 2
      ;;
    *)
      log_error "Unknown option: $1"
      exit 1
      ;;
  esac
done

# --- Base paths ---
if [[ "$INSTALL_MODE" == "system" ]]; then
  TOOLCHAIN_ROOT="/opt/toolchains"
else
  TOOLCHAIN_ROOT="$HOME/toolchains"
fi

SRC_DIR="$TOOLCHAIN_ROOT/sources"

# --- Create directory structure ---
log_info "Creating directory structure at $TOOLCHAIN_ROOT"
mkdir -p "$SRC_DIR"

# --- Clone/update repos ---
clone_or_update() {
  local url="$1"
  local dir="$2"
  local tag="$3"
  local name="$(basename "$dir")"

  if [[ ! -d "$dir/.git" ]]; then
    log_info "Cloning $name..."
    git clone --depth=1 "$url" "$dir"
  else
    log_info "Updating $name..."
    git -C "$dir" fetch --tags --prune --depth=1
  fi

  if [[ -n "$tag" ]]; then
    log_info "Checking out $tag"
    git -C "$dir" fetch origin "$tag" --depth=1 2>/dev/null || true
    git -C "$dir" checkout "$tag"
  else
    git -C "$dir" checkout master 2>/dev/null || git -C "$dir" checkout main 2>/dev/null || true
    git -C "$dir" pull --ff-only 2>/dev/null || true
  fi
}

clone_or_update "git://sourceware.org/git/binutils-gdb.git" "$SRC_DIR/binutils" "$BINUTILS_TAG"
clone_or_update "git://gcc.gnu.org/git/gcc.git" "$SRC_DIR/gcc" "$GCC_TAG"
clone_or_update "git://sourceware.org/git/newlib-cygwin.git" "$SRC_DIR/newlib" "$NEWLIB_TAG"

# --- Create config.mk ---
CONFIG_FILE="$TOOLCHAIN_ROOT/config.mk"
log_info "Creating $CONFIG_FILE"

cat > "$CONFIG_FILE" << EOF
# Toolchain configuration
# Generated by setup-toolchain.sh on $(date)

TOOLCHAIN_ROOT := $TOOLCHAIN_ROOT
SRC_DIR := \$(TOOLCHAIN_ROOT)/sources
BINUTILS_SRC := \$(SRC_DIR)/binutils
GCC_SRC := \$(SRC_DIR)/gcc
NEWLIB_SRC := \$(SRC_DIR)/newlib

# Build settings
JOBS ?= $(nproc)
LANGUAGES ?= c,c++

# Source versions
BINUTILS_VERSION := $(git -C "$SRC_DIR/binutils" log -1 --format="%h %s" 2>/dev/null || echo "unknown")
GCC_VERSION := $(git -C "$SRC_DIR/gcc" log -1 --format="%h %s" 2>/dev/null || echo "unknown")
NEWLIB_VERSION := $(git -C "$SRC_DIR/newlib" log -1 --format="%h %s" 2>/dev/null || echo "unknown")
EOF

log_ok "Setup complete!"
echo
log_info "Source versions:"
echo "  Binutils: $(git -C "$SRC_DIR/binutils" log -1 --oneline 2>/dev/null || echo "unknown")"
echo "  GCC:      $(git -C "$SRC_DIR/gcc" log -1 --oneline 2>/dev/null || echo "unknown")"
echo "  Newlib:   $(git -C "$SRC_DIR/newlib" log -1 --oneline 2>/dev/null || echo "unknown")"
echo
log_info "Next steps:"
echo "  1. cd $TOOLCHAIN_ROOT"
echo "  2. make TARGET=riscv64-unknown-elf"
echo "  or"
echo "  2. make TARGET=arm-none-eabi WITH_NEWLIB=1"
